<div class="hm-mt" data-hm-mt>
  <div class="hm-chrome">
    <div class="hm-dots">
      <span class="hm-dot hm-dot-r"></span>
      <span class="hm-dot hm-dot-y"></span>
      <span class="hm-dot hm-dot-g"></span>
    </div>
    <span class="hm-title">PATAPIM</span>
  </div>
  <div class="hm-layout">
    <!-- Sidebar -->
    <div class="hm-sidebar">
      <div class="hm-sb-section">
        <div class="hm-sb-header">PROJECTS</div>
        <div class="hm-sb-item hm-sb-active" data-proj="0">
          <span class="hm-sb-dot" style="background:#7cb382"></span>
          <span class="hm-sb-name">my-app</span>
          <span class="hm-notif-dot" data-notif="0"></span>
          <span class="hm-sb-badge">3</span>
        </div>
        <div class="hm-sb-item" data-proj="1">
          <span class="hm-sb-dot" style="background:#6ba4d4"></span>
          <span class="hm-sb-name">api-server</span>
          <span class="hm-notif-dot" data-notif="1"></span>
          <span class="hm-sb-badge">2</span>
        </div>
        <div class="hm-sb-item" data-proj="2">
          <span class="hm-sb-dot" style="background:#e0a458"></span>
          <span class="hm-sb-name">docs</span>
          <span class="hm-notif-dot" data-notif="2"></span>
          <span class="hm-sb-badge">1</span>
        </div>
      </div>
      <div class="hm-sb-section">
        <div class="hm-sb-header">TASKS</div>
        <div class="hm-sb-task" data-task="fix-auth">
          <span class="hm-task-icon" data-task-icon="fix-auth">
            <span class="hm-task-circle">&#x25CB;</span>
            <span class="hm-task-checkmark">&#x2713;</span>
          </span>
          <span class="hm-task-running-dot" data-task-dot="fix-auth"></span>
          Fix auth flow
        </div>
        <div class="hm-sb-task" data-task="add-tests">
          <span class="hm-task-icon" data-task-icon="add-tests">
            <span class="hm-task-circle">&#x25CB;</span>
            <span class="hm-task-checkmark">&#x2713;</span>
          </span>
          <span class="hm-task-running-dot" data-task-dot="add-tests"></span>
          Add tests
        </div>
        <div class="hm-sb-task hm-task-done"><span class="hm-task-check hm-done">&#x2713;</span> Setup CI</div>
      </div>
    </div>
    <!-- Main area -->
    <div class="hm-main">
      <div class="hm-tabs" data-hm-tabs>
        <span class="hm-tab hm-tab-active" data-tab="0">Claude</span>
        <span class="hm-tab" data-tab="1">Dev</span>
        <span class="hm-tab" data-tab="2">Tests</span>
        <span class="hm-tab-add">+</span>
      </div>
      <div class="hm-terminal" data-hm-term>
        <div class="hm-tln" data-tln="0"></div>
        <div class="hm-tln" data-tln="1"></div>
        <div class="hm-tln" data-tln="2"></div>
        <div class="hm-tln" data-tln="3"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .hm-mt {
    width: 340px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-strong);
    background: var(--bg-deep);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .hm-chrome {
    background: var(--bg-tertiary);
    padding: 5px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--border-default);
  }
  .hm-dots { display: flex; gap: 4px; }
  .hm-dot { width: 6px; height: 6px; border-radius: 50%; }
  .hm-dot-r { background: #ff5f57; }
  .hm-dot-y { background: #febc2e; }
  .hm-dot-g { background: #28c840; }
  .hm-title {
    font-family: var(--font-mono);
    font-size: 8px;
    color: var(--text-tertiary);
    letter-spacing: 0.05em;
  }

  .hm-layout {
    display: flex;
    height: 180px;
  }

  /* Sidebar */
  .hm-sidebar {
    width: 95px;
    flex-shrink: 0;
    border-right: 1px solid var(--border-default);
    background: rgba(255,255,255,0.015);
    padding: 6px 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .hm-sb-section { }
  .hm-sb-header {
    font-family: var(--font-mono);
    font-size: 6.5px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    padding: 0 6px 2px;
  }
  .hm-sb-item {
    display: flex;
    align-items: center;
    gap: 3px;
    padding: 2.5px 6px;
    font-family: var(--font-mono);
    font-size: 7.5px;
    color: var(--text-muted);
    cursor: default;
    transition: all 0.2s ease;
    position: relative;
  }
  .hm-sb-item.hm-sb-active {
    background: rgba(212,165,116,0.1);
    color: var(--text-primary);
  }
  .hm-sb-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .hm-sb-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Notification dot on project items */
  .hm-notif-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: #e87040;
    flex-shrink: 0;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
  }
  .hm-notif-dot.hm-notif-show {
    opacity: 1;
    transform: scale(1);
  }

  .hm-sb-badge {
    font-size: 6.5px;
    background: rgba(255,255,255,0.08);
    color: var(--text-muted);
    padding: 0 3px;
    border-radius: 3px;
    min-width: 10px;
    text-align: center;
  }

  /* Task items */
  .hm-sb-task {
    display: flex;
    align-items: center;
    gap: 3px;
    padding: 1.5px 6px;
    font-family: var(--font-mono);
    font-size: 6.5px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
  }
  .hm-task-icon {
    flex-shrink: 0;
    position: relative;
    width: 8px;
    height: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .hm-task-circle {
    font-size: 7px;
    transition: all 0.3s ease;
  }
  .hm-task-checkmark {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 7px;
    color: var(--success);
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s ease;
  }

  /* Task completed state */
  .hm-sb-task.hm-task-completed .hm-task-circle {
    opacity: 0;
    transform: scale(0.5);
  }
  .hm-sb-task.hm-task-completed .hm-task-checkmark {
    opacity: 1;
    transform: scale(1);
  }
  .hm-sb-task.hm-task-completed {
    color: var(--success);
  }

  /* Task completion flash */
  .hm-sb-task.hm-task-flash {
    background: rgba(40, 200, 64, 0.1);
    transition: background 0.5s ease;
  }

  /* Running dot (pulsing orange) */
  .hm-task-running-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #e0a458;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .hm-task-running-dot.hm-dot-show {
    opacity: 1;
    animation: hm-dot-pulse 1.2s ease-in-out infinite;
  }
  @keyframes hm-dot-pulse {
    0%, 100% { opacity: 0.4; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
  }

  .hm-task-check {
    font-size: 7px;
    flex-shrink: 0;
  }
  .hm-task-done {
    opacity: 0.4;
    text-decoration: line-through;
  }
  .hm-done { color: var(--success); }

  /* Main area */
  .hm-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  .hm-tabs {
    display: flex;
    align-items: center;
    gap: 1px;
    padding: 0 4px;
    background: rgba(255,255,255,0.02);
    border-bottom: 1px solid var(--border-default);
  }
  .hm-tab {
    font-family: var(--font-mono);
    font-size: 7.5px;
    color: var(--text-muted);
    padding: 4px 6px;
    cursor: default;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }
  .hm-tab.hm-tab-active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
  }
  .hm-tab-add {
    font-size: 9px;
    color: var(--text-muted);
    padding: 2px 4px;
    margin-left: auto;
  }

  .hm-terminal {
    flex: 1;
    padding: 6px 8px;
    font-family: var(--font-mono);
    font-size: 7.5px;
    line-height: 1.5;
    color: var(--text-secondary);
    overflow: hidden;
  }
  .hm-tln {
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
    min-height: 12px;
  }
  .hm-tln.hm-vis { opacity: 1; }

  @media (max-width: 768px) {
    .hm-mt { width: 100%; max-width: 340px; }
  }

  @media (prefers-reduced-motion: reduce) {
    .hm-tln { opacity: 1; }
    .hm-task-running-dot { animation: none !important; }
  }
</style>

<script>
  (function() {
    const root = document.querySelector('[data-hm-mt]') as HTMLElement;
    if (!root) return;

    const projects = root.querySelectorAll('[data-proj]');
    const tabs = root.querySelectorAll('[data-tab]');
    const lines = root.querySelectorAll('[data-tln]');

    // Task elements
    const taskFixAuth = root.querySelector('[data-task="fix-auth"]') as HTMLElement;
    const taskAddTests = root.querySelector('[data-task="add-tests"]') as HTMLElement;
    const dotFixAuth = root.querySelector('[data-task-dot="fix-auth"]') as HTMLElement;
    const dotAddTests = root.querySelector('[data-task-dot="add-tests"]') as HTMLElement;
    const notifDots = root.querySelectorAll('[data-notif]');

    const projectData: Record<string, { tabs: string[]; activeTab: number; lines: string[][] }> = {
      '0': {
        tabs: ['Claude', 'Dev', 'Tests'],
        activeTab: 0,
        lines: [
          ['> fix the auth flow', '✓ Updated auth middleware', '✓ Added token refresh', '> Ready.'],
          ['$ npm run dev', 'Server on :3000', 'Watching files...', ''],
          ['$ npm test', 'PASS auth.test', 'PASS api.test', '3 passed']
        ]
      },
      '1': {
        tabs: ['Claude', 'Server'],
        activeTab: 0,
        lines: [
          ['> add rate limiting', '✓ Added middleware', '✓ Config: 100 req/min', '> Done.'],
          ['$ node server.js', 'Listening on :8080', 'DB connected', '']
        ]
      },
      '2': {
        tabs: ['Build'],
        activeTab: 0,
        lines: [
          ['$ npm run build', 'Building pages...', '✓ 12 pages built', 'Done in 1.8s']
        ]
      }
    };

    function setProject(idx: string) {
      projects.forEach(p => p.classList.remove('hm-sb-active'));
      root.querySelector(`[data-proj="${idx}"]`)?.classList.add('hm-sb-active');

      // Clear notification dot for this project when switching to it
      const notif = root.querySelector(`[data-notif="${idx}"]`);
      if (notif) notif.classList.remove('hm-notif-show');

      const data = projectData[idx];
      const tabContainer = root.querySelector('[data-hm-tabs]') as HTMLElement;
      // Rebuild tabs
      tabContainer.innerHTML = '';
      data.tabs.forEach((name, i) => {
        const span = document.createElement('span');
        span.className = 'hm-tab' + (i === data.activeTab ? ' hm-tab-active' : '');
        span.dataset.tab = String(i);
        span.textContent = name;
        tabContainer.appendChild(span);
      });
      const addSpan = document.createElement('span');
      addSpan.className = 'hm-tab-add';
      addSpan.textContent = '+';
      tabContainer.appendChild(addSpan);

      setTab(idx, data.activeTab);
    }

    function setTab(projIdx: string, tabIdx: number) {
      const data = projectData[projIdx];
      const tabEls = root.querySelectorAll('[data-tab]');
      tabEls.forEach((t, i) => {
        t.classList.toggle('hm-tab-active', i === tabIdx);
      });
      data.activeTab = tabIdx;

      const content = data.lines[tabIdx] || [];
      lines.forEach((ln, i) => {
        (ln as HTMLElement).textContent = content[i] || '';
        ln.classList.remove('hm-vis');
      });
    }

    function showLines() {
      lines.forEach((ln, i) => {
        setTimeout(() => ln.classList.add('hm-vis'), i * 120);
      });
    }

    function resetTaskStates() {
      taskFixAuth?.classList.remove('hm-task-completed', 'hm-task-flash');
      taskAddTests?.classList.remove('hm-task-completed', 'hm-task-flash');
      dotFixAuth?.classList.remove('hm-dot-show');
      dotAddTests?.classList.remove('hm-dot-show');
      notifDots.forEach(d => d.classList.remove('hm-notif-show'));
    }

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      setProject('0');
      showLines();
      return;
    }

    let running = false;
    let animId: ReturnType<typeof setTimeout> | null = null;

    function wait(ms: number): Promise<void> {
      return new Promise(resolve => { animId = setTimeout(resolve, ms); });
    }

    function resetState() {
      setProject('0');
      lines.forEach(ln => ln.classList.remove('hm-vis'));
      resetTaskStates();
    }

    async function startLoop() {
      while (running) {
        // 0-2s: Project "my-app" active, Claude tab, "Fix auth flow" running
        resetState();
        dotFixAuth?.classList.add('hm-dot-show');
        showLines();
        await wait(2000);
        if (!running) break;

        // 2-3.5s: Task "Fix auth flow" completes (circle → checkmark, green flash)
        dotFixAuth?.classList.remove('hm-dot-show');
        taskFixAuth?.classList.add('hm-task-completed', 'hm-task-flash');
        await wait(1500);
        if (!running) break;
        taskFixAuth?.classList.remove('hm-task-flash');

        // 3.5-5s: Switch to Dev tab, notification dot on api-server
        setTab('0', 1);
        lines.forEach(ln => ln.classList.remove('hm-vis'));
        await wait(100);
        if (!running) break;
        showLines();
        const apiNotif = root.querySelector('[data-notif="1"]');
        apiNotif?.classList.add('hm-notif-show');
        await wait(1500);
        if (!running) break;

        // 5-7s: Switch to project "api-server" (notification clears)
        setProject('1');
        lines.forEach(ln => ln.classList.remove('hm-vis'));
        await wait(100);
        if (!running) break;
        showLines();
        await wait(2000);
        if (!running) break;

        // 7-9s: Switch to project "docs"
        setProject('2');
        lines.forEach(ln => ln.classList.remove('hm-vis'));
        await wait(100);
        if (!running) break;
        showLines();
        await wait(2000);
        if (!running) break;

        // 9-10s: Switch back to "my-app", "Add tests" now running
        setProject('0');
        // Re-apply fix-auth completed state
        taskFixAuth?.classList.add('hm-task-completed');
        lines.forEach(ln => ln.classList.remove('hm-vis'));
        await wait(100);
        if (!running) break;
        dotAddTests?.classList.add('hm-dot-show');
        showLines();
        await wait(2000);
        if (!running) break;

        // Fade & loop
        root.style.opacity = '0';
        root.style.transition = 'opacity 0.4s ease';
        await wait(400);
        if (!running) break;
        root.style.opacity = '1';
      }
    }

    const obs = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting && !running) {
          running = true;
          startLoop();
        } else if (!e.isIntersecting && running) {
          running = false;
          if (animId) { clearTimeout(animId); animId = null; }
          resetState();
          root.style.opacity = '1';
        }
      });
    }, { threshold: 0.3 });
    obs.observe(root);
  })();
</script>
