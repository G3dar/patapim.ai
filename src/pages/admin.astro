---
export const prerender = false;

import { getUserFromRequest } from '../lib/auth';
import { isAdmin } from '../lib/admin';

const env = Astro.locals.runtime.env;
const user = await getUserFromRequest(env.SESSIONS, Astro.request);

if (!user) {
  return Astro.redirect('/api/auth/google');
}

if (!isAdmin(user)) {
  return Astro.redirect('/go');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — PATAPIM</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
</head>
<body>

  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-left">
        <a href="/" class="topbar-brand">
          <span class="brand-icon">&#x276F;_</span>
          <span class="brand-text">PATAPIM</span>
        </a>
        <span class="topbar-sep"></span>
        <span class="topbar-label">Admin</span>
      </div>
      <div class="topbar-right">
        <img src={user.picture} alt="" class="topbar-avatar" referrerpolicy="no-referrer" />
        <span class="topbar-email">{user.email}</span>
        <a href="/go" class="topbar-link">Dashboard</a>
      </div>
    </div>
  </header>

  <main class="admin-main">
    <div class="admin-container">

      <!-- Tabs -->
      <nav class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="users">Users</button>
        <button class="tab" data-tab="referrals">Referrals</button>
        <button class="tab" data-tab="feedback">Feedback</button>
      </nav>

      <!-- Overview -->
      <section class="pane" id="tab-overview">
        <div class="loader" id="overview-loading">Loading...</div>
        <div id="overview-content" style="display:none;"></div>
      </section>

      <!-- Users -->
      <section class="pane" id="tab-users" style="display:none;">
        <div class="toolbar">
          <input type="text" class="toolbar-search" id="user-search" placeholder="Search by email or name..." />
          <select class="toolbar-select" id="plan-filter">
            <option value="all">All Plans</option>
            <option value="free">Free</option>
            <option value="pro">Pro</option>
            <option value="lifetime">Lifetime</option>
          </select>
        </div>
        <div class="loader" id="users-loading">Loading...</div>
        <div id="users-content" style="display:none;"></div>
      </section>

      <!-- Referrals -->
      <section class="pane" id="tab-referrals" style="display:none;">
        <div class="loader" id="referrals-loading">Loading...</div>
        <div id="referrals-content" style="display:none;"></div>
      </section>

      <!-- Feedback -->
      <section class="pane" id="tab-feedback" style="display:none;">
        <div class="loader" id="feedback-loading">Loading...</div>
        <div id="feedback-content" style="display:none;"></div>
      </section>

    </div>
  </main>

<style is:global>
  /* ── Reset ────────────────────────────── */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;

    --blue-50: #eff6ff;
    --blue-100: #dbeafe;
    --blue-500: #3b82f6;
    --blue-600: #2563eb;
    --blue-700: #1d4ed8;

    --green-50: #f0fdf4;
    --green-100: #dcfce7;
    --green-500: #22c55e;
    --green-600: #16a34a;
    --green-700: #15803d;

    --amber-50: #fffbeb;
    --amber-100: #fef3c7;
    --amber-500: #f59e0b;
    --amber-600: #d97706;
    --amber-700: #b45309;

    --red-50: #fef2f2;
    --red-100: #fee2e2;
    --red-500: #ef4444;
    --red-600: #dc2626;

    --purple-50: #faf5ff;
    --purple-500: #a855f7;
    --purple-600: #9333ea;

    --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    --radius: 10px;
    --radius-sm: 6px;
    --shadow-card: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  }

  body {
    font-family: var(--font);
    background: var(--gray-50);
    color: var(--gray-800);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  /* ── Top Bar ──────────────────────────── */
  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .topbar-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: var(--gray-900);
    font-weight: 700;
    font-size: 15px;
  }

  .brand-icon {
    font-family: var(--mono);
    color: var(--blue-600);
  }

  .topbar-sep {
    width: 1px;
    height: 20px;
    background: var(--gray-200);
  }

  .topbar-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--red-600);
    background: var(--red-50);
    padding: 2px 10px;
    border-radius: 100px;
    letter-spacing: 0.3px;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--gray-200);
  }

  .topbar-email {
    font-size: 13px;
    color: var(--gray-500);
  }

  .topbar-link {
    font-size: 13px;
    font-weight: 500;
    color: var(--blue-600);
    text-decoration: none;
    margin-left: 8px;
  }

  .topbar-link:hover { text-decoration: underline; }

  /* ── Main ──────────────────────────────── */
  .admin-main {
    padding: 32px 24px 64px;
  }

  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ── Tabs ──────────────────────────────── */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 28px;
    border-bottom: 1px solid var(--gray-200);
  }

  .tab {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 10px 20px;
    font-family: var(--font);
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-400);
    cursor: pointer;
    transition: all 150ms;
  }

  .tab:hover { color: var(--gray-600); }

  .tab.active {
    color: var(--blue-600);
    border-bottom-color: var(--blue-600);
  }

  /* ── Loader ────────────────────────────── */
  .loader {
    text-align: center;
    padding: 48px;
    color: var(--gray-400);
    font-size: 14px;
  }

  /* ── Stats Grid ────────────────────────── */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .kpi {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 20px 24px;
    box-shadow: var(--shadow-card);
    transition: box-shadow 150ms;
  }

  .kpi:hover { box-shadow: var(--shadow-md); }

  .kpi-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-400);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .kpi-value {
    font-family: var(--mono);
    font-size: 32px;
    font-weight: 700;
    color: var(--gray-900);
    line-height: 1;
    margin-bottom: 6px;
  }

  .kpi-sub {
    font-size: 12px;
    color: var(--gray-500);
    line-height: 1.4;
  }

  .kpi-sub .up {
    color: var(--green-600);
    font-weight: 600;
  }

  .kpi.revenue { border-left: 3px solid var(--green-500); }
  .kpi.revenue .kpi-value { color: var(--green-700); }

  /* ── Breakdown chips ───────────────────── */
  .breakdown-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 28px;
  }

  .breakdown-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 100px;
    padding: 6px 16px;
    font-size: 13px;
    color: var(--gray-700);
    box-shadow: var(--shadow-card);
  }

  .breakdown-chip .chip-count {
    font-family: var(--mono);
    font-weight: 600;
    color: var(--gray-900);
  }

  .breakdown-chip .chip-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .chip-dot.active { background: var(--green-500); }
  .chip-dot.trialing { background: var(--blue-500); }
  .chip-dot.past_due, .chip-dot.payment_failed { background: var(--amber-500); }
  .chip-dot.canceled, .chip-dot.expired { background: var(--red-500); }
  .chip-dot.unknown { background: var(--gray-400); }

  /* ── Trends Chart ──────────────────────── */
  .trends-section {
    margin-bottom: 8px;
  }

  .section-heading {
    font-size: 15px;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 14px;
  }

  .chart-wrap {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 20px 24px 16px;
    box-shadow: var(--shadow-card);
  }

  .chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    height: 140px;
  }

  .chart-day {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    gap: 6px;
  }

  .chart-pair {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    flex: 1;
    width: 100%;
    justify-content: center;
  }

  .bar {
    width: 14px;
    min-height: 3px;
    border-radius: 3px 3px 0 0;
    position: relative;
  }

  .bar:hover::after {
    content: attr(data-tip);
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--gray-800);
    color: var(--white);
    font-size: 11px;
    font-family: var(--mono);
    padding: 3px 8px;
    border-radius: 4px;
    white-space: nowrap;
    z-index: 10;
    pointer-events: none;
  }

  .bar.signups { background: var(--blue-500); }
  .bar.downloads { background: var(--amber-500); }

  .chart-label {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--gray-400);
  }

  .chart-legend {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 14px;
  }

  .legend {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--gray-500);
  }

  .legend-swatch {
    width: 10px;
    height: 10px;
    border-radius: 3px;
  }

  .legend-swatch.signups { background: var(--blue-500); }
  .legend-swatch.downloads { background: var(--amber-500); }

  /* ── Toolbar ───────────────────────────── */
  .toolbar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  .toolbar-search {
    flex: 1;
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    padding: 9px 14px;
    font-size: 14px;
    font-family: var(--font);
    color: var(--gray-800);
    outline: none;
    transition: border-color 150ms, box-shadow 150ms;
  }

  .toolbar-search::placeholder { color: var(--gray-400); }
  .toolbar-search:focus {
    border-color: var(--blue-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
  }

  .toolbar-select {
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    padding: 9px 14px;
    font-size: 14px;
    font-family: var(--font);
    color: var(--gray-700);
    cursor: pointer;
    outline: none;
    min-width: 140px;
  }

  /* ── Table ─────────────────────────────── */
  .tbl-wrap {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    overflow-x: auto;
  }

  .tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .tbl th {
    text-align: left;
    padding: 12px 16px;
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-400);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--gray-200);
    white-space: nowrap;
    background: var(--gray-50);
  }

  .tbl td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-100);
    color: var(--gray-600);
    vertical-align: middle;
  }

  .tbl tr:last-child td { border-bottom: none; }
  .tbl tbody tr:hover td { background: var(--blue-50); }

  /* User cell */
  .ucell {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .ucell-av {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid var(--gray-200);
  }

  .ucell-info { display: flex; flex-direction: column; }

  .ucell-name {
    font-weight: 600;
    color: var(--gray-800);
    font-size: 13px;
  }

  .ucell-email {
    font-size: 11px;
    color: var(--gray-400);
  }

  /* Badges */
  .badge {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 100px;
    white-space: nowrap;
    display: inline-block;
  }

  .badge-free { background: var(--gray-100); color: var(--gray-600); }
  .badge-pro { background: var(--blue-100); color: var(--blue-700); }
  .badge-lifetime { background: var(--purple-50); color: var(--purple-600); }

  .badge-active { background: var(--green-100); color: var(--green-700); }
  .badge-trialing { background: var(--blue-100); color: var(--blue-700); }
  .badge-past_due, .badge-payment_failed { background: var(--amber-100); color: var(--amber-700); }
  .badge-canceled, .badge-expired { background: var(--red-100); color: var(--red-600); }

  .badge-granted { background: var(--green-100); color: var(--green-700); }
  .badge-pending { background: var(--gray-100); color: var(--gray-500); }

  /* Plan change select */
  .plan-sel {
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    padding: 4px 10px;
    font-size: 12px;
    font-family: var(--mono);
    color: var(--gray-700);
    cursor: pointer;
    outline: none;
  }

  /* Pagination */
  .tbl-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--gray-500);
    background: var(--gray-50);
    border-top: 1px solid var(--gray-100);
  }

  .tbl-count {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 16px;
  }

  .btn-load {
    background: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    padding: 6px 18px;
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 150ms;
  }

  .btn-load:hover {
    background: var(--gray-50);
    border-color: var(--blue-500);
    color: var(--blue-600);
  }

  .no-data {
    text-align: center;
    padding: 48px;
    color: var(--gray-400);
    font-size: 14px;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
  }

  /* ── Referrals ─────────────────────────── */
  .ref-toggle {
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    padding: 2px 6px;
    font-size: 13px;
    transition: color 150ms;
  }

  .ref-toggle:hover { color: var(--blue-600); }

  .ref-detail { display: none; }
  .ref-detail.open { display: table-row; }

  .ref-detail td {
    padding: 8px 16px 16px;
    background: var(--gray-50);
  }

  .ref-chips {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ref-chip {
    font-size: 11px;
    font-family: var(--mono);
    padding: 4px 12px;
    border-radius: 100px;
    background: var(--white);
    border: 1px solid var(--gray-200);
  }

  .ref-chip.ok {
    border-color: var(--green-500);
    color: var(--green-700);
    background: var(--green-50);
  }

  .ref-chip.wait {
    color: var(--gray-400);
  }

  /* ── Feedback ──────────────────────────── */
  .fb-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .fb-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 20px 24px;
    box-shadow: var(--shadow-card);
  }

  .fb-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .fb-email {
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-800);
  }

  .fb-time {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--gray-400);
  }

  .fb-text {
    font-size: 14px;
    color: var(--gray-600);
    line-height: 1.7;
  }

  .fb-rating {
    margin-top: 10px;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--amber-500);
  }

  /* ── Confirm Modal ─────────────────────── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(4px);
  }

  .modal-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 32px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 8px;
  }

  .modal-desc {
    font-size: 14px;
    color: var(--gray-500);
    margin-bottom: 24px;
    line-height: 1.5;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .modal-btn {
    padding: 9px 24px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--gray-300);
    transition: all 150ms;
    font-family: var(--font);
  }

  .modal-btn.ok {
    background: var(--blue-600);
    color: var(--white);
    border-color: var(--blue-600);
  }

  .modal-btn.ok:hover { background: var(--blue-700); }

  .modal-btn.no {
    background: var(--white);
    color: var(--gray-600);
  }

  .modal-btn.no:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
  }

  /* ── Responsive ────────────────────────── */
  @media (max-width: 900px) {
    .kpi-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .topbar-email { display: none; }

    .kpi-grid {
      grid-template-columns: 1fr 1fr;
    }

    .kpi-value { font-size: 24px; }

    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      white-space: nowrap;
      padding: 8px 16px;
      font-size: 13px;
    }

    .toolbar {
      flex-direction: column;
    }

    .chart-bars { height: 100px; }
  }
</style>

<script>
  // ── State ──
  let currentTab = 'overview';
  const loaded: Record<string, boolean> = {};
  let searchTimeout: ReturnType<typeof setTimeout> | null = null;

  // ── Tab switching ──
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = (btn as HTMLElement).dataset.tab!;
      switchTab(tab);
    });
  });

  function switchTab(tab: string) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(b => b.classList.toggle('active', (b as HTMLElement).dataset.tab === tab));
    document.querySelectorAll('.pane').forEach(c => (c as HTMLElement).style.display = c.id === `tab-${tab}` ? 'block' : 'none');
    if (!loaded[tab]) {
      loaded[tab] = true;
      if (tab === 'overview') loadOverview();
      else if (tab === 'users') loadUsers();
      else if (tab === 'referrals') loadReferrals();
      else if (tab === 'feedback') loadFeedback();
    }
  }

  // ── Search / filter ──
  document.getElementById('user-search')?.addEventListener('input', () => {
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadUsers(), 300);
  });
  document.getElementById('plan-filter')?.addEventListener('change', () => loadUsers());

  // ── Helpers ──
  function esc(s: string) {
    if (!s) return '';
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function fmtDate(iso: string) {
    if (!iso) return '\u2014';
    try { return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
    catch { return iso; }
  }

  // ── Overview ──
  async function loadOverview() {
    try {
      const res = await fetch('/api/admin/stats');
      const s = await res.json();
      document.getElementById('overview-loading')!.style.display = 'none';
      const el = document.getElementById('overview-content')!;
      el.style.display = 'block';

      el.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi">
            <div class="kpi-label">Total Users</div>
            <div class="kpi-value">${s.users.total}</div>
            <div class="kpi-sub"><span class="up">+${s.users.newToday}</span> today &middot; +${s.users.newThisWeek} this week &middot; +${s.users.newThisMonth} month</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Licensed Users</div>
            <div class="kpi-value">${s.licenses.total}</div>
            <div class="kpi-sub">${s.licenses.pro} Pro &middot; ${s.licenses.lifetime} Lifetime</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Active Devices</div>
            <div class="kpi-value">${s.devices.total}</div>
            <div class="kpi-sub"><span class="up">${s.devices.onlineNow}</span> online now &middot; ${s.devices.avgPerUser} avg/user</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Downloads</div>
            <div class="kpi-value">${s.downloads.total}</div>
            <div class="kpi-sub"><span class="up">+${s.downloads.today}</span> today &middot; +${s.downloads.thisWeek} this week</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Referral Program</div>
            <div class="kpi-value">${s.referrals.totalReferrers}</div>
            <div class="kpi-sub">${s.referrals.totalInvitations} invited &middot; ${s.referrals.totalActivations} activated &middot; ${s.referrals.totalRewards} rewarded</div>
          </div>
          <div class="kpi revenue">
            <div class="kpi-label">Est. MRR</div>
            <div class="kpi-value">$${s.revenue.mrr.toFixed(2)}</div>
            <div class="kpi-sub">Lifetime total: $${s.revenue.lifetimeRevenue.toFixed(2)}</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Feedback</div>
            <div class="kpi-value">${s.feedback.total}</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Referral Conv. Rate</div>
            <div class="kpi-value">${s.referrals.conversionRate}%</div>
          </div>
        </div>

        ${buildBreakdown(s.licenses.statusBreakdown)}

        <div class="trends-section">
          <div class="section-heading">Last 7 Days</div>
          <div class="chart-wrap">
            <div class="chart-bars">${buildChart(s.trends)}</div>
            <div class="chart-legend">
              <span class="legend"><span class="legend-swatch signups"></span> Signups</span>
              <span class="legend"><span class="legend-swatch downloads"></span> Downloads</span>
            </div>
          </div>
        </div>
      `;
    } catch {
      document.getElementById('overview-loading')!.textContent = 'Failed to load stats.';
    }
  }

  function buildBreakdown(bd: Record<string, number>) {
    const entries = Object.entries(bd);
    if (!entries.length) return '';
    return `<div class="breakdown-row">${entries.map(([s, c]) =>
      `<span class="breakdown-chip"><span class="chip-dot ${s}"></span> <span class="chip-count">${c}</span> ${s}</span>`
    ).join('')}</div>`;
  }

  function buildChart(trends: Array<{ date: string; signups: number; downloads: number }>) {
    const mx = Math.max(1, ...trends.map(t => Math.max(t.signups, t.downloads)));
    return trends.map(t => {
      const sH = Math.max(3, (t.signups / mx) * 100);
      const dH = Math.max(3, (t.downloads / mx) * 100);
      return `
        <div class="chart-day">
          <div class="chart-pair">
            <div class="bar signups" style="height:${sH}px" data-tip="${t.signups} signups"></div>
            <div class="bar downloads" style="height:${dH}px" data-tip="${t.downloads} downloads"></div>
          </div>
          <span class="chart-label">${t.date.slice(5)}</span>
        </div>`;
    }).join('');
  }

  // ── Users ──
  async function loadUsers(cursor?: string | null) {
    const search = (document.getElementById('user-search') as HTMLInputElement)?.value || '';
    const plan = (document.getElementById('plan-filter') as HTMLSelectElement)?.value || 'all';
    const p = new URLSearchParams();
    if (search) p.set('search', search);
    if (plan !== 'all') p.set('plan', plan);
    if (cursor) p.set('cursor', cursor);

    try {
      const res = await fetch(`/api/admin/users?${p}`);
      const data = await res.json();
      document.getElementById('users-loading')!.style.display = 'none';
      const el = document.getElementById('users-content')!;
      el.style.display = 'block';

      if (!data.users.length) {
        el.innerHTML = '<div class="no-data">No users found.</div>';
        return;
      }

      el.innerHTML = `
        <div class="tbl-count">${data.total} users</div>
        <div class="tbl-wrap">
          <table class="tbl">
            <thead><tr>
              <th>User</th><th>Plan</th><th>Status</th><th>Devices</th><th>Joined</th><th>Last Login</th><th>Change Plan</th>
            </tr></thead>
            <tbody>
              ${data.users.map((u: any) => `<tr>
                <td><div class="ucell">
                  ${u.picture ? `<img src="${esc(u.picture)}" class="ucell-av" referrerpolicy="no-referrer" />` : ''}
                  <div class="ucell-info"><span class="ucell-name">${esc(u.name)}</span><span class="ucell-email">${esc(u.email)}</span></div>
                </div></td>
                <td><span class="badge badge-${u.plan}">${u.plan === 'free' ? 'Free' : u.plan === 'pro' ? 'Pro' : 'Lifetime'}</span></td>
                <td>${u.licenseStatus ? `<span class="badge badge-${u.licenseStatus}">${u.licenseStatus}</span>` : '<span style="color:var(--gray-300)">\u2014</span>'}</td>
                <td style="font-family:var(--mono);font-size:13px;color:var(--gray-700)">${u.deviceCount}</td>
                <td style="font-size:12px;white-space:nowrap">${fmtDate(u.createdAt)}</td>
                <td style="font-size:12px;white-space:nowrap">${fmtDate(u.lastLogin)}</td>
                <td><select class="plan-sel" data-email="${esc(u.email)}" data-gid="${esc(u.googleId)}" data-cur="${u.plan}">
                  <option value="free"${u.plan==='free'?' selected':''}>Free</option>
                  <option value="pro"${u.plan==='pro'?' selected':''}>Pro</option>
                  <option value="lifetime"${u.plan==='lifetime'?' selected':''}>Lifetime</option>
                </select></td>
              </tr>`).join('')}
            </tbody>
          </table>
          <div class="tbl-footer">
            <span>${data.users.length} of ${data.total}</span>
            ${data.nextCursor ? `<button class="btn-load" id="load-more">Load More</button>` : ''}
          </div>
        </div>
      `;

      // Plan change
      el.querySelectorAll('.plan-sel').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const s = e.target as HTMLSelectElement;
          const nw = s.value, cur = s.dataset.cur;
          if (nw === cur) return;
          showModal(
            `Change plan to ${nw}?`,
            `Update ${s.dataset.email} from ${cur} to ${nw}.`,
            async () => {
              const r = await fetch('/api/admin/update-plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: s.dataset.email, googleId: s.dataset.gid, plan: nw }),
              });
              if (r.ok) { s.dataset.cur = nw; loadUsers(); }
              else { s.value = cur!; alert('Failed to update plan.'); }
            },
            () => { s.value = cur!; }
          );
        });
      });

      document.getElementById('load-more')?.addEventListener('click', () => loadUsers(data.nextCursor));
    } catch {
      document.getElementById('users-loading')!.textContent = 'Failed to load users.';
    }
  }

  // ── Referrals ──
  async function loadReferrals() {
    try {
      const res = await fetch('/api/admin/referrals');
      const data = await res.json();
      document.getElementById('referrals-loading')!.style.display = 'none';
      const el = document.getElementById('referrals-content')!;
      el.style.display = 'block';

      const s = data.summary;
      el.innerHTML = `
        <div class="kpi-grid" style="margin-bottom:24px;">
          <div class="kpi"><div class="kpi-label">Referrers</div><div class="kpi-value">${s.totalReferrers}</div></div>
          <div class="kpi"><div class="kpi-label">Invitations</div><div class="kpi-value">${s.totalInvitations}</div></div>
          <div class="kpi"><div class="kpi-label">Activations</div><div class="kpi-value">${s.totalActivations}</div></div>
          <div class="kpi"><div class="kpi-label">Conversion</div><div class="kpi-value">${s.conversionRate}%</div></div>
        </div>

        ${!data.referrers.length ? '<div class="no-data">No referrals yet.</div>' : `
          <div class="tbl-wrap"><table class="tbl">
            <thead><tr><th></th><th>Email</th><th>Invited</th><th>Activated</th><th>Conv.</th><th>Reward</th></tr></thead>
            <tbody>
              ${data.referrers.map((r: any, i: number) => `
                <tr>
                  <td><button class="ref-toggle" data-i="${i}">${r.referrals.length ? '&#9654;' : ''}</button></td>
                  <td style="font-family:var(--mono);font-size:12px">${esc(r.email)}</td>
                  <td style="font-family:var(--mono)">${r.invited}</td>
                  <td style="font-family:var(--mono)">${r.activated}</td>
                  <td style="font-family:var(--mono)">${r.conversionRate}%</td>
                  <td><span class="badge badge-${r.rewardGranted?'granted':'pending'}">${r.rewardGranted?'Granted':'Pending'}</span></td>
                </tr>
                <tr class="ref-detail" id="rd-${i}"><td colspan="6">
                  <ul class="ref-chips">${r.referrals.map((x: any) =>
                    `<li class="ref-chip ${x.activatedAt?'ok':'wait'}">${esc(x.email)} ${x.activatedAt?'&#10003;':'&#8230;'}</li>`
                  ).join('')}</ul>
                </td></tr>
              `).join('')}
            </tbody>
          </table></div>
        `}
      `;

      el.querySelectorAll('.ref-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = (btn as HTMLElement).dataset.i;
          const d = document.getElementById(`rd-${i}`);
          if (d) { d.classList.toggle('open'); (btn as HTMLElement).innerHTML = d.classList.contains('open') ? '&#9660;' : '&#9654;'; }
        });
      });
    } catch {
      document.getElementById('referrals-loading')!.textContent = 'Failed to load referrals.';
    }
  }

  // ── Feedback ──
  async function loadFeedback() {
    try {
      const res = await fetch('/api/admin/feedback');
      const data = await res.json();
      document.getElementById('feedback-loading')!.style.display = 'none';
      const el = document.getElementById('feedback-content')!;
      el.style.display = 'block';

      if (!data.feedback.length) {
        el.innerHTML = '<div class="no-data">No feedback yet.</div>';
        return;
      }

      el.innerHTML = `<div class="fb-list">${data.feedback.map((f: any) => `
        <div class="fb-card">
          <div class="fb-head">
            <span class="fb-email">${esc(f.email)}</span>
            <span class="fb-time">${fmtDate(f.timestamp)}</span>
          </div>
          <div class="fb-text">${esc(f.feedback)}</div>
          ${f.rating != null ? `<div class="fb-rating">${'&#9733;'.repeat(f.rating)}${'&#9734;'.repeat(5-f.rating)}</div>` : ''}
        </div>
      `).join('')}</div>`;
    } catch {
      document.getElementById('feedback-loading')!.textContent = 'Failed to load feedback.';
    }
  }

  // ── Modal ──
  function showModal(title: string, desc: string, onOk: () => void, onNo: () => void) {
    const ov = document.createElement('div');
    ov.className = 'modal-overlay';
    ov.innerHTML = `<div class="modal-card">
      <div class="modal-title">${title}</div>
      <div class="modal-desc">${desc}</div>
      <div class="modal-actions">
        <button class="modal-btn no" id="m-no">Cancel</button>
        <button class="modal-btn ok" id="m-ok">Confirm</button>
      </div>
    </div>`;
    document.body.appendChild(ov);
    ov.querySelector('#m-ok')!.addEventListener('click', () => { ov.remove(); onOk(); });
    ov.querySelector('#m-no')!.addEventListener('click', () => { ov.remove(); onNo(); });
  }

  // ── Boot ──
  switchTab('overview');
</script>

</body>
</html>
