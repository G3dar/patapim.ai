---
export const prerender = true;

import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';

const features = [
  'Unlimited terminals & projects',
  'Unlimited voice dictation',
  'Remote access from anywhere',
  'Task & GitHub panels',
  'Plugin marketplace',
  'PassKey / Biometric auth',
];
---

<BaseLayout title="Upgrade to Pro â€” PATAPIM" description="Upgrade PATAPIM to Pro. Unlimited terminals, voice dictation, remote access, and more.">
  <Navbar />

  <main class="upgrade-page">
    <div class="container">
      <div class="section-header" style="padding-top: 120px;">
        <h1 class="section-title">Upgrade to Pro</h1>
        <p class="section-subtitle">
          Unlock the full power of PATAPIM. Choose the plan that works for you.
        </p>
      </div>

      <div class="upgrade-cards">
        <!-- Pro Monthly -->
        <div class="u-card featured">
          <div class="u-badge">Most Popular</div>
          <h3>Pro</h3>
          <div class="u-price">
            <span class="u-amount">$6.99</span>
            <span class="u-period">/month</span>
          </div>
          <p class="u-desc">Cancel anytime. No commitment.</p>
          <a href="#" class="btn btn-primary" id="checkout-pro" style="width:100%; justify-content:center;">Go Pro</a>
        </div>

        <!-- Unlock Forever -->
        <div class="u-card lifetime">
          <div class="u-badge lifetime-badge">Best Value</div>
          <h3>Unlock Forever</h3>
          <div class="u-price">
            <span class="u-amount">$29.99</span>
            <span class="u-period">one-time</span>
          </div>
          <p class="u-desc">Pay once, keep Pro features forever.</p>
          <a href="#" class="btn btn-primary" id="checkout-lifetime" style="width:100%; justify-content:center;">Unlock Forever</a>
        </div>
      </div>

      <!-- Referral section -->
      <div class="referral-section">
        <button class="referral-toggle" id="referral-toggle" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
          <span>Referred by someone?</span>
          <svg class="referral-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="referral-form-container" id="referral-form">
          <p class="referral-hint">Enter the email of the person who told you about PATAPIM. They'll get credit toward a free license.</p>
          <input type="email" class="referral-input" id="referral-email" placeholder="friend@example.com" autocomplete="email" />
          <p class="referral-error" id="referral-error"></p>
        </div>
      </div>

      <!-- Shared feature list -->
      <div class="features-section">
        <h4 class="features-heading">Everything included with Pro</h4>
        <ul class="features-list">
          {features.map((f) => (
            <li>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12" /></svg>
              {f}
            </li>
          ))}
        </ul>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .upgrade-page {
    min-height: 100vh;
  }

  .upgrade-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-xl);
    max-width: 640px;
    margin: 0 auto;
  }

  .u-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
    position: relative;
    text-align: center;
  }

  .u-card.featured {
    border-color: var(--accent-primary);
    box-shadow: 0 0 40px rgba(212, 165, 116, 0.1);
  }

  .u-card.lifetime {
    border-color: var(--warning);
    box-shadow: 0 0 40px rgba(224, 164, 88, 0.08);
  }

  .u-badge {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent-primary);
    color: var(--bg-deep);
    font-size: 12px;
    font-weight: 600;
    padding: 4px 16px;
    border-radius: 100px;
    white-space: nowrap;
  }

  .u-badge.lifetime-badge {
    background: var(--warning);
  }

  .u-card h3 {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: var(--space-sm);
    margin-top: var(--space-sm);
  }

  .u-price {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 4px;
    margin-bottom: var(--space-xs);
  }

  .u-amount {
    font-size: 42px;
    font-weight: 700;
    font-family: var(--font-mono);
  }

  .u-period {
    font-size: 16px;
    color: var(--text-tertiary);
  }

  .u-desc {
    font-size: 14px;
    color: var(--text-tertiary);
    margin-bottom: var(--space-xl);
  }

  /* Features section */
  .features-section {
    max-width: 480px;
    margin: var(--space-2xl) auto 0;
    text-align: center;
  }

  .features-heading {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-lg);
  }

  .features-list {
    list-style: none;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-sm) var(--space-xl);
    text-align: left;
  }

  .features-list li {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 14px;
    color: var(--text-secondary);
  }

  .features-list li svg {
    color: var(--accent-primary);
    flex-shrink: 0;
  }

  /* Referral section */
  .referral-section {
    max-width: 640px;
    margin: var(--space-xl) auto 0;
    text-align: center;
  }

  .referral-toggle {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    background: transparent;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 8px 16px;
    color: var(--text-tertiary);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }

  .referral-toggle:hover {
    color: var(--text-secondary);
    border-color: var(--text-tertiary);
  }

  .referral-chevron {
    transition: transform 0.2s;
  }

  .referral-toggle.open .referral-chevron {
    transform: rotate(180deg);
  }

  .referral-form-container {
    display: none;
    margin-top: var(--space-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
  }

  .referral-form-container.open {
    display: block;
  }

  .referral-hint {
    font-size: 13px;
    color: var(--text-tertiary);
    margin-bottom: var(--space-md);
    line-height: 1.5;
  }

  .referral-input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-deep);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .referral-input:focus {
    border-color: var(--accent-primary);
  }

  .referral-input::placeholder {
    color: var(--text-tertiary);
    opacity: 0.6;
  }

  .referral-error {
    font-size: 12px;
    color: var(--error, #e55);
    margin-top: var(--space-xs);
    min-height: 18px;
  }

  @media (max-width: 640px) {
    .upgrade-cards {
      grid-template-columns: 1fr;
    }
    .features-list {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Referral toggle
  const toggleBtn = document.getElementById('referral-toggle')!;
  const formContainer = document.getElementById('referral-form')!;

  toggleBtn.addEventListener('click', () => {
    const isOpen = toggleBtn.classList.toggle('open');
    formContainer.classList.toggle('open', isOpen);
  });

  // Pre-fill from ?ref= URL param
  const urlParams = new URLSearchParams(window.location.search);
  const refParam = urlParams.get('ref');
  if (refParam) {
    (document.getElementById('referral-email') as HTMLInputElement).value = refParam;
    toggleBtn.classList.add('open');
    formContainer.classList.add('open');
  }

  async function handleCheckout(plan: 'pro' | 'lifetime') {
    const btn = document.getElementById(plan === 'pro' ? 'checkout-pro' : 'checkout-lifetime');
    const errorEl = document.getElementById('referral-error')!;
    errorEl.textContent = '';

    if (btn) btn.setAttribute('disabled', '');
    try {
      // Try to get email from URL query param (passed from PATAPIM app)
      const params = new URLSearchParams(window.location.search);
      let email: string | undefined = params.get('email') || undefined;

      // Fallback: try authenticated session
      if (!email) {
        try {
          const sessionRes = await fetch('/api/auth/session');
          if (sessionRes.ok) {
            const sessionData = await sessionRes.json();
            if (sessionData.authenticated) email = sessionData.user.email;
          }
        } catch {}
      }

      // Get referrer email if entered
      const referralInput = document.getElementById('referral-email') as HTMLInputElement;
      const referrerEmail = referralInput.value.trim() || undefined;

      // Client-side self-referral check
      if (referrerEmail && email && referrerEmail.toLowerCase() === email.toLowerCase()) {
        errorEl.textContent = 'You cannot refer yourself.';
        if (btn) btn.removeAttribute('disabled');
        return;
      }

      const res = await fetch('/api/stripe/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan, email, referrerEmail }),
      });
      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        console.error('Checkout error:', data.error);
        if (data.error === 'Cannot refer yourself') {
          errorEl.textContent = 'You cannot refer yourself.';
        }
        if (btn) btn.removeAttribute('disabled');
      }
    } catch (err) {
      console.error('Checkout error:', err);
      if (btn) btn.removeAttribute('disabled');
    }
  }

  document.getElementById('checkout-pro')?.addEventListener('click', (e) => {
    e.preventDefault();
    handleCheckout('pro');
  });

  document.getElementById('checkout-lifetime')?.addEventListener('click', (e) => {
    e.preventDefault();
    handleCheckout('lifetime');
  });
</script>
