---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { getUserFromRequest } from '../lib/auth';

const env = Astro.locals.runtime.env;
const user = await getUserFromRequest(env.SESSIONS, Astro.request);

if (!user) {
  return Astro.redirect('/api/auth/google');
}

// Server-side data fetch
const [licenseRaw, userRaw] = await Promise.all([
  env.LICENSES.get(`license:${user.email}`),
  env.LICENSES.get(`user:${user.googleId}`),
]);

const license = licenseRaw ? JSON.parse(licenseRaw) : null;
const userData = userRaw ? JSON.parse(userRaw) : null;
const plan = license?.plan || userData?.plan || 'free';
const stripeCustomerId = license?.stripeCustomerId || userData?.stripeCustomerId || null;

const paired = Astro.url.searchParams.get('paired') === '1';
---

<BaseLayout title="Dashboard â€” PATAPIM" description="Manage your PATAPIM devices and sessions.">
  <Navbar />

  <!-- Success overlay for post-pairing -->
  {paired && (
    <div class="success-overlay" id="success-overlay">
      <div class="success-card">
        <div class="success-check">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <h2 class="success-title">Signed In</h2>
        <p class="success-desc">Your desktop app is now connected.</p>
        <p class="success-close">You can close this tab.</p>
        <a href="/go" class="success-dashboard-link">Go to Dashboard</a>
      </div>
    </div>
  )}

  <main class="dashboard-page">
    <div class="container">
      <!-- Dashboard Header -->
      <div class="dash-header">
        <div class="dash-user">
          <img src={user.picture} alt="" class="dash-avatar" referrerpolicy="no-referrer" />
          <div class="dash-user-info">
            <div class="dash-name-row">
              <span class="dash-name">{user.name}</span>
              <span class={`plan-badge plan-${plan}`}>
                {plan === 'free' ? 'Free' : plan === 'pro' ? 'Pro' : 'Lifetime'}
              </span>
            </div>
            <span class="dash-email">{user.email}</span>
          </div>
        </div>
        <div class="dash-actions">
          {stripeCustomerId && stripeCustomerId !== 'referral' && (
            <button class="btn-link" id="manage-billing-btn">Manage Billing</button>
          )}
          {plan === 'free' && (
            <a href="/pricing" class="btn-link btn-link-accent">Upgrade</a>
          )}
          <button class="btn btn-secondary btn-sm" id="sign-out-btn">Sign Out</button>
        </div>
      </div>

      <!-- Active Sessions -->
      <div class="dash-section">
        <h2 class="section-title">Active Sessions</h2>
        <div id="devices-loading" class="panel-loading">Loading devices...</div>
        <div id="devices-content" style="display:none;"></div>
      </div>

      <!-- Link Desktop App -->
      <div class="dash-section">
        <div class="pair-section">
          <h3>Link Desktop App</h3>
          <p class="pair-desc">Generate a one-time code, then paste it in your PATAPIM desktop app.</p>

          <!-- Before generation -->
          <div id="pair-pre">
            <button class="btn btn-primary" id="generate-pair-btn">Generate Pairing Code</button>
          </div>

          <!-- After generation -->
          <div id="pair-post" style="display:none;">
            <div class="pair-code-card" id="pair-code-card" title="Click to copy">
              <span class="pair-code-chars" id="pair-code-value"></span>
              <span class="pair-copy-hint" id="pair-copy-hint">Click to copy</span>
            </div>
            <div class="pair-meta">
              <span class="pair-timer" id="pair-timer"></span>
              <button class="pair-regen" id="pair-regen-btn">Regenerate</button>
            </div>
            <p class="pair-instruction">Open PATAPIM desktop &rarr; Settings &rarr; Paste this code</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .dashboard-page {
    min-height: 100vh;
    padding-top: 96px;
    padding-bottom: var(--space-4xl);
  }

  /* Success Overlay */
  .success-overlay {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(10, 10, 11, 0.92);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .success-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--space-4xl) var(--space-3xl);
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    max-width: 400px;
    width: 90%;
  }

  .success-check {
    color: var(--success);
    margin-bottom: var(--space-xl);
  }

  .success-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }

  .success-desc {
    font-size: 17px;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
    line-height: 1.5;
  }

  .success-close {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-3xl);
  }

  .success-dashboard-link {
    font-size: 13px;
    color: var(--text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .success-dashboard-link:hover {
    color: var(--text-secondary);
  }

  /* Dashboard Header */
  .dash-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-xl) 0;
    border-bottom: 1px solid var(--border-subtle);
    margin-bottom: var(--space-2xl);
  }

  .dash-user {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }

  .dash-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid var(--border-default);
  }

  .dash-user-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .dash-name-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .dash-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .dash-email {
    font-size: 13px;
    color: var(--text-tertiary);
  }

  .dash-actions {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }

  .btn-link {
    background: none;
    border: none;
    color: var(--text-tertiary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    padding: 0;
    transition: color var(--transition-fast);
  }

  .btn-link:hover {
    color: var(--text-primary);
  }

  .btn-link-accent {
    color: var(--accent-primary);
    text-decoration: none;
  }

  .btn-link-accent:hover {
    color: var(--text-primary);
  }

  .btn-sm {
    padding: 6px 16px;
    font-size: 13px;
  }

  .plan-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 100px;
  }

  .plan-free {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
  }

  .plan-pro {
    background: var(--accent-primary);
    color: var(--bg-deep);
  }

  .plan-lifetime {
    background: rgba(224, 164, 88, 0.15);
    color: var(--warning);
  }

  /* Sections */
  .dash-section {
    margin-bottom: var(--space-2xl);
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xl);
  }

  .panel-loading {
    text-align: center;
    padding: var(--space-3xl);
    color: var(--text-muted);
    font-size: 14px;
  }

  /* Pairing */
  .pair-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
  }

  .pair-section h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--space-sm);
  }

  .pair-desc {
    font-size: 14px;
    color: var(--text-tertiary);
    margin-bottom: var(--space-lg);
  }

  .pair-code-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-xl) var(--space-2xl);
    cursor: pointer;
    transition: border-color var(--transition-fast), background var(--transition-fast);
    user-select: all;
  }

  .pair-code-card:hover {
    border-color: var(--accent-primary);
    background: var(--bg-secondary);
  }

  .pair-code-chars {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 40px;
    font-weight: 700;
    color: var(--accent-primary);
    letter-spacing: 8px;
  }

  .pair-copy-hint {
    font-size: 12px;
    color: var(--text-muted);
    transition: color var(--transition-fast);
  }

  .pair-copy-hint.copied {
    color: var(--accent-primary);
    font-weight: 600;
  }

  .pair-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: var(--space-lg);
  }

  .pair-timer {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 14px;
    color: var(--text-tertiary);
  }

  .pair-timer.warning {
    color: #e57c23;
  }

  .pair-timer.expired {
    color: var(--text-muted);
  }

  .pair-regen {
    background: none;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: var(--space-xs) var(--space-md);
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color var(--transition-fast), border-color var(--transition-fast);
  }

  .pair-regen:hover {
    color: var(--accent-primary);
    border-color: var(--accent-primary);
  }

  .pair-instruction {
    margin-top: var(--space-lg);
    font-size: 13px;
    color: var(--text-muted);
    text-align: center;
  }

  @media (max-width: 640px) {
    .dash-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-lg);
    }

    .dash-actions {
      width: 100%;
      justify-content: flex-end;
    }
  }
</style>

<!-- Dynamic content styles (injected by JS, can't be scoped) -->
<style is:global>
  /* Device Cards */
  .devices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-lg);
  }

  .device-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    transition: border-color var(--transition-fast);
  }

  .device-card:hover {
    border-color: var(--border-strong);
  }

  .device-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
  }

  .device-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .online-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 100px;
    letter-spacing: 0.2px;
  }

  .online-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  .online-badge.online {
    background: rgba(124, 179, 130, 0.12);
    color: var(--success);
  }

  .online-badge.online::before {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
  }

  .online-badge.offline {
    background: var(--bg-tertiary);
    color: var(--text-muted);
  }

  .online-badge.offline::before {
    background: var(--text-muted);
  }

  .device-meta {
    font-size: 13px;
    color: var(--text-tertiary);
    margin-bottom: var(--space-lg);
    line-height: 1.7;
  }

  .device-meta span {
    display: block;
  }

  .device-meta .meta-label {
    color: var(--text-muted);
  }

  .device-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .connect-btn {
    font-size: 12px;
    font-weight: 600;
    color: var(--bg-deep);
    background: var(--accent-primary);
    border: 1px solid var(--accent-primary);
    border-radius: var(--radius-sm);
    padding: 6px 18px;
    cursor: pointer;
    transition: opacity var(--transition-fast), background var(--transition-fast);
  }

  .connect-btn:hover {
    opacity: 0.9;
  }

  .connect-btn:disabled {
    opacity: 0.5;
    cursor: wait;
  }

  .unlink-btn {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    background: none;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    padding: 5px 14px;
    cursor: pointer;
    transition: color var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast);
  }

  .unlink-btn:hover {
    color: var(--error);
    border-color: var(--error);
    background: rgba(212, 120, 120, 0.06);
  }

  /* Empty state (dynamic) */
  .dash-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
  }

  .dash-empty-icon {
    color: var(--text-muted);
    margin-bottom: var(--space-xl);
    opacity: 0.6;
  }

  .dash-empty-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }

  .dash-empty-desc {
    font-size: 14px;
    color: var(--text-tertiary);
    margin-bottom: var(--space-2xl);
    max-width: 400px;
  }

  @media (max-width: 640px) {
    .devices-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ stripeCustomerId }}>
  // Load devices immediately on page load
  loadDevices();

  // Manage billing
  document.getElementById('manage-billing-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('manage-billing-btn');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    try {
      const res = await fetch('/api/stripe/portal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId: stripeCustomerId }),
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else { btn.disabled = false; btn.textContent = 'Manage Billing'; }
    } catch {
      btn.disabled = false;
      btn.textContent = 'Manage Billing';
    }
  });

  // Pairing code logic
  {
    let pairTimerInterval = null;

    function flashCopied() {
      const hint = document.getElementById('pair-copy-hint');
      hint.textContent = 'Copied!';
      hint.classList.add('copied');
      setTimeout(() => {
        hint.textContent = 'Click to copy';
        hint.classList.remove('copied');
      }, 1500);
    }

    async function copyCode() {
      const code = document.getElementById('pair-code-value').textContent;
      if (!code) return;
      try { await navigator.clipboard.writeText(code); } catch {}
      flashCopied();
    }

    function startTimer(seconds) {
      if (pairTimerInterval) clearInterval(pairTimerInterval);
      let remaining = seconds;
      const timerEl = document.getElementById('pair-timer');
      function tick() {
        if (remaining <= 0) {
          timerEl.textContent = 'Expired';
          timerEl.className = 'pair-timer expired';
          clearInterval(pairTimerInterval);
          pairTimerInterval = null;
          return;
        }
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        timerEl.textContent = m + ':' + String(s).padStart(2, '0');
        timerEl.className = remaining <= 60 ? 'pair-timer warning' : 'pair-timer';
        remaining--;
      }
      tick();
      pairTimerInterval = setInterval(tick, 1000);
    }

    async function generateCode() {
      try {
        const res = await fetch('/api/device/pair-code', { method: 'POST' });
        const data = await res.json();
        if (data.code) {
          document.getElementById('pair-code-value').textContent = data.code;
          document.getElementById('pair-pre').style.display = 'none';
          document.getElementById('pair-post').style.display = 'block';
          startTimer(600);
          try { await navigator.clipboard.writeText(data.code); } catch {}
          flashCopied();
        }
      } catch {}
    }

    document.getElementById('generate-pair-btn')?.addEventListener('click', generateCode);
    document.getElementById('pair-regen-btn')?.addEventListener('click', generateCode);
    document.getElementById('pair-code-card')?.addEventListener('click', copyCode);
  }

  // Sign out
  document.getElementById('sign-out-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('sign-out-btn');
    btn.disabled = true;
    btn.textContent = 'Signing out...';
    try { await fetch('/api/auth/logout', { method: 'POST' }); } catch {}
    window.location.href = '/';
  });

  // Load devices
  async function loadDevices() {
    try {
      const res = await fetch('/api/device/list');
      const data = await res.json();
      const container = document.getElementById('devices-content');
      document.getElementById('devices-loading').style.display = 'none';
      container.style.display = 'block';

      if (!data.devices || data.devices.length === 0) {
        container.innerHTML = `
          <div class="dash-empty">
            <div class="dash-empty-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
              </svg>
            </div>
            <h3 class="dash-empty-title">No active sessions</h3>
            <p class="dash-empty-desc">Link your desktop app to see your sessions here.</p>
          </div>`;
        return;
      }

      container.innerHTML = '<div class="devices-grid">' + data.devices.map(d => {
        const lastSeen = new Date(d.lastSeen);
        const ago = timeAgo(lastSeen);
        return `
          <div class="device-card">
            <div class="device-card-header">
              <span class="device-name">${escapeHtml(d.deviceName)}</span>
              <span class="online-badge ${d.online ? 'online' : 'offline'}">${d.online ? 'Online' : 'Offline'}</span>
            </div>
            <div class="device-meta">
              <span>Last seen: ${ago}</span>
              ${d.terminalCount ? `<span>Terminals: ${d.terminalCount}</span>` : ''}
            </div>
            <div class="device-actions">
              ${d.online && d.tunnelUrl ? `<button class="connect-btn" data-token="${escapeHtml(d.token)}">Connect</button>` : ''}
              <button class="unlink-btn" data-token="${escapeHtml(d.token)}">Unlink</button>
            </div>
          </div>`;
      }).join('') + '</div>';

      // Connect handlers
      container.querySelectorAll('.connect-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.textContent = 'Connecting...';
          try {
            const res = await fetch('/api/device/connect-token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deviceToken: btn.dataset.token }),
            });
            const result = await res.json();
            if (result.connectToken && result.tunnelUrl) {
              window.open(
                '/remote?t=' + encodeURIComponent(result.connectToken) +
                '&url=' + encodeURIComponent(result.tunnelUrl),
                '_blank'
              );
            } else {
              alert(result.error || 'Failed to connect');
            }
          } catch {
            alert('Failed to connect to device');
          }
          btn.disabled = false;
          btn.textContent = 'Connect';
        });
      });

      // Unlink handlers
      container.querySelectorAll('.unlink-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Unlink this device?')) return;
          btn.disabled = true;
          btn.textContent = 'Unlinking...';
          try {
            await fetch('/api/device/unlink', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deviceToken: btn.dataset.token }),
            });
            loadDevices();
          } catch {
            btn.disabled = false;
            btn.textContent = 'Unlink';
          }
        });
      });
    } catch {
      document.getElementById('devices-loading').textContent = 'Failed to load devices.';
    }
  }

  function timeAgo(date) {
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
</script>
